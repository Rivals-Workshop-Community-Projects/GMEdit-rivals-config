name: Release

on:
  repository_dispatch:
    types: [gmedit-plugin-push]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create revision'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - run: echo "Getting release ${{ github.event.client_payload.tag }}"
    - name: Download GMEdit Plugin
      uses: dsaltares/fetch-gh-release-asset@master
      with:
        repo: "Rivals-Workshop-Community-Projects/rivals-workshop-assistant-gmedit"
        version: "tags/${{ github.event.client_payload.tag }}"
        file: "rivals-workshop-assistant.zip"
        target: "tmp/gmedit-plugin.zip"
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Decompress GMEdit Plugin
      uses: TonyBogdanov/zip@1.0
      with:
          args: unzip -qq ./tmp/gmedit-plugin.zip -d ./plugins

    - run: ls tmp

    - run: mkdir -p tmp/rivals-workshop-assistant-gmedit
    - run: rsync -a --exclude='.*' --exclude='tmp' . tmp/rivals-workshop-assistant-gmedit
    - uses: papeloto/action-zip@v1
      with:
        files: tmp/
        dest: tmp/GMEdit-rivals-config.zip

    - uses: actions/upload-artifact@v1
      with:
        name: zip_preview
        path: tmp/GMEdit-rivals-config.zip

    - name: Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: "tmp/GMEdit-rivals-config.zip"
        tag_name: ${{ github.event.client_payload.tag }}
